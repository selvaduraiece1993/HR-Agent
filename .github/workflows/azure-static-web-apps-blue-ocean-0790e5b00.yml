name: Deploy Next.js to Azure App Service with .env.local

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------
      # 1. Load .env.local and convert to JSON
      # -----------------------------------------
      - name: Load .env.local
        id: loadenv
        run: |
          if [ ! -f ".env.local" ]; then
            echo "❌ .env.local not found!"
            exit 1
          fi

          echo "Creating env.json for Azure App Settings..."

          echo "{" > env.json
          while IFS='=' read -r key value; do
            [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
            echo "\"$key\": \"$value\"," >> env.json
          done < .env.local
          sed -i '$ s/,$//' env.json
          echo "}" >> env.json

          echo "Generated env.json:"
          cat env.json

      # -----------------------------------------
      # 2. Install Node
      # -----------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # -----------------------------------------
      # 3. Install Deps
      # -----------------------------------------
      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      # -----------------------------------------
      # 4. Build
      # -----------------------------------------
      - name: Build Next.js app
        run: npm run build
        env:
          ${{ steps.loadenv.outputs }}

      # -----------------------------------------
      # 5. Apply .env.local to Azure App Settings
      # -----------------------------------------
      - name: Set Azure App Settings from env.json
        uses: azure/appservice-settings@v1
        with:
          app-name: HR-Agent     # ← Replace this
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
          app-settings-json: ./env.json

      # -----------------------------------------
      # 6. Deploy App
      # -----------------------------------------
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: HR-Agent     # ← Replace this
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
          package: .
